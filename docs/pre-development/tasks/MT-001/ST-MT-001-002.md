# ST-MT-001-002: Implement Local File Storage System

## Status
- **Status:** ✅ Complete
- **Completion Date:** 2025-01-08
- **Implementation:** Successfully implemented in `cli/internal/adapters/secondary/storage/file_storage.go`

## 1. Sub-Task Overview
- **Sub-Task ID:** ST-MT-001-002
- **Sub-Task Name:** Implement Local File Storage System
- **Parent Task:** MT-001: CLI Foundation with Local Storage and MCP Integration
- **Estimated Duration:** 4 hours
- **Implementation Type:** Code

## 2. Deliverable Specification
- **Primary Output:** Local file storage implementation for ~/.lmmc/ directory
- **Code Location:** `cli/internal/adapters/secondary/storage/file_store.go`
- **Technical Requirements:** Atomic file operations, JSON serialization, directory management
- **Interface Definition:** Storage interface implementation with CRUD operations

## 3. Implementation Details
- **Step-by-Step Approach:**
  1. Create storage interface in `cli/internal/domain/ports/storage.go`
  2. Implement file storage adapter in secondary adapters
  3. Create ~/.lmmc/ directory structure management
  4. Implement atomic file operations with backup
  5. Add JSON serialization for task data
  6. Implement repository-based file organization
  7. Add file locking for concurrent access
  8. Create migration utilities for data format changes

- **Code Examples:**
  ```go
  // Domain interface
  type Storage interface {
      SaveTask(task *Task) error
      GetTask(id string) (*Task, error)
      ListTasks(repository string, filters TaskFilters) ([]*Task, error)
      UpdateTask(task *Task) error
      DeleteTask(id string) error
      GetTasksByRepository(repository string) ([]*Task, error)
  }
  
  // File storage implementation
  type FileStorage struct {
      basePath string
      mutex    sync.RWMutex
  }
  
  func NewFileStorage() (*FileStorage, error) {
      homeDir, err := os.UserHomeDir()
      if err != nil {
          return nil, fmt.Errorf("failed to get home directory: %w", err)
      }
      
      basePath := filepath.Join(homeDir, ".lmmc")
      if err := os.MkdirAll(basePath, 0755); err != nil {
          return nil, fmt.Errorf("failed to create .lmmc directory: %w", err)
      }
      
      return &FileStorage{basePath: basePath}, nil
  }
  
  func (fs *FileStorage) SaveTask(task *Task) error {
      fs.mutex.Lock()
      defer fs.mutex.Unlock()
      
      repoPath := fs.getRepositoryPath(task.Repository)
      if err := os.MkdirAll(repoPath, 0755); err != nil {
          return err
      }
      
      filePath := filepath.Join(repoPath, "tasks.json")
      return fs.atomicWriteTask(filePath, task)
  }
  
  func (fs *FileStorage) atomicWriteTask(filePath string, task *Task) error {
      // Read existing tasks
      tasks, _ := fs.readTasksFromFile(filePath)
      
      // Update or add task
      found := false
      for i, existingTask := range tasks {
          if existingTask.ID == task.ID {
              tasks[i] = task
              found = true
              break
          }
      }
      if !found {
          tasks = append(tasks, task)
      }
      
      // Atomic write with backup
      tempFile := filePath + ".tmp"
      backupFile := filePath + ".backup"
      
      if err := fs.writeTasksToFile(tempFile, tasks); err != nil {
          return err
      }
      
      // Create backup if original exists
      if _, err := os.Stat(filePath); err == nil {
          os.Rename(filePath, backupFile)
      }
      
      // Atomic move
      if err := os.Rename(tempFile, filePath); err != nil {
          // Restore backup on failure
          if _, backupErr := os.Stat(backupFile); backupErr == nil {
              os.Rename(backupFile, filePath)
          }
          return err
      }
      
      // Remove backup on success
      os.Remove(backupFile)
      return nil
  }
  ```

- **Configuration Changes:** None required
- **Dependencies:** Standard Go library only (os, filepath, encoding/json, sync)

## 4. Acceptance Criteria
- **Functional Criteria:**
  - Tasks are persisted in ~/.lmmc/ directory structure
  - Repository-based organization works correctly
  - All CRUD operations function properly
  - Data survives CLI restarts
  - Concurrent access is safe with file locking
  
- **Technical Criteria:**
  - Atomic file operations prevent corruption
  - JSON format is human-readable and valid
  - Directory permissions are secure (755 for dirs, 644 for files)
  - Error handling provides actionable messages
  
- **Integration Criteria:**
  - Implements Storage interface completely
  - Can be used by TaskService without coupling
  - Compatible with MCP sync operations
  
- **Test Criteria:**
  - All storage operations tested
  - Concurrent access scenarios tested
  - File corruption recovery tested

## 5. Testing Requirements
- **Unit Tests:**
  - Task creation and retrieval from files
  - Repository-based filtering works correctly
  - Atomic write operations prevent corruption
  - Directory creation and permissions
  - JSON serialization handles all task fields
  - Concurrent access with multiple CLI instances
  - Error handling for disk full, permissions, etc.
  - Backup and recovery mechanisms

- **Integration Tests:**
  - Cross-platform file operations (Windows/macOS/Linux)
  - Large dataset handling (1000+ tasks)
  - Migration between data format versions
  
- **Manual Testing:** 
  - Verify ~/.lmmc/ directory structure
  - Check file permissions and accessibility
  - Test behavior with disk space issues
  
- **Test Data:** Create test tasks covering all field combinations

## 6. Definition of Done
- **Code Complete:** FileStorage fully implements Storage interface
- **Tests Passing:** All unit and integration tests pass (≥85% coverage)
- **Documentation Updated:** Interface and implementation documented
- **Integration Verified:** Used successfully by TaskService
- **Review Approved:** Security and performance review completed

## 7. Dependencies and Blockers
- **Required Sub-Tasks:** ST-MT-001-001 (Task Entity) must be complete
- **External Dependencies:** None (uses standard library)
- **Environmental Requirements:** File system write permissions in home directory
- **Potential Blockers:** File system permissions, disk space limitations

## 8. Integration Notes
- **Component Interfaces:** Implements Storage port from domain layer
- **Data Flow:** CLI commands → TaskService → FileStorage → ~/.lmmc/ files
- **Error Handling:** Graceful handling of I/O errors with user-friendly messages
- **Configuration Impact:** Creates ~/.lmmc/ directory structure on first use