# Production PostgreSQL Configuration for MCP Memory Server
# This configuration optimizes PostgreSQL for production workloads

# =============================================================================
# CONNECTION AND AUTHENTICATION
# =============================================================================

listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# Connection pooling
shared_preload_libraries = 'pg_stat_statements'

# Authentication
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'

# =============================================================================
# MEMORY CONFIGURATION
# =============================================================================

# Shared memory settings
shared_buffers = 512MB              # 25% of RAM for dedicated DB server
temp_buffers = 32MB                 # Temporary tables memory
work_mem = 16MB                     # Memory for query operations
maintenance_work_mem = 256MB        # Memory for maintenance operations
effective_cache_size = 1GB          # OS cache size estimate

# =============================================================================
# WRITE AHEAD LOG (WAL) CONFIGURATION
# =============================================================================

# WAL settings for reliability and performance
wal_level = replica
wal_buffers = 16MB
max_wal_size = 2GB
min_wal_size = 256MB
checkpoint_completion_target = 0.9
checkpoint_timeout = 5min
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/archive/%f'

# =============================================================================
# QUERY PLANNER CONFIGURATION
# =============================================================================

# Query planner settings
random_page_cost = 1.1              # SSD storage
effective_io_concurrency = 200      # SSD concurrent I/O
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# =============================================================================
# BACKGROUND WRITER CONFIGURATION
# =============================================================================

# Background writer settings
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 512kB

# =============================================================================
# AUTOVACUUM CONFIGURATION
# =============================================================================

# Autovacuum settings for optimal maintenance
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 500

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

# Logging settings
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0644
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_min_messages = info
log_min_error_statement = error
log_min_duration_statement = 1000   # Log queries taking > 1 second
log_statement = 'mod'               # Log data modification statements
log_duration = on
log_line_prefix = '%m [%p] %q%u@%d '
log_lock_waits = on
log_temp_files = 1024kB
log_checkpoints = on
log_connections = on
log_disconnections = on
log_hostname = on

# =============================================================================
# RUNTIME STATISTICS
# =============================================================================

# Statistics collection
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = '/var/run/postgresql'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================

# Client connection defaults
default_text_search_config = 'pg_catalog.english'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Statement timeout
statement_timeout = 30s
lock_timeout = 10s
idle_in_transaction_session_timeout = 60s

# =============================================================================
# PERFORMANCE OPTIMIZATION
# =============================================================================

# Performance related settings
synchronous_commit = on
wal_sync_method = fdatasync
full_page_writes = on
wal_compression = on
wal_init_zero = on
wal_recycle = on

# Parallel query settings
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000.0

# =============================================================================
# REPLICATION (if needed)
# =============================================================================

# Replication settings (uncomment if using replication)
# max_wal_senders = 3
# max_replication_slots = 3
# hot_standby = on
# hot_standby_feedback = on

# =============================================================================
# EXTENSION CONFIGURATION
# =============================================================================

# Shared preload libraries for extensions
# shared_preload_libraries = 'pg_stat_statements,auto_explain'

# Auto explain settings (uncomment to enable)
# auto_explain.log_min_duration = 1000
# auto_explain.log_analyze = on
# auto_explain.log_buffers = on
# auto_explain.log_timing = on
# auto_explain.log_triggers = on
# auto_explain.log_verbose = on
# auto_explain.log_nested_statements = on

# =============================================================================
# SECURITY SETTINGS
# =============================================================================

# Security related settings
ssl_prefer_server_ciphers = on
ssl_ciphers = 'ECDHE+AESGCM:ECDHE+CHACHA20:ECDHE+AES256:ECDHE+AES128:!aNULL:!SHA1'
ssl_ecdh_curve = 'prime256v1'
ssl_dh_params_file = '/var/lib/postgresql/dh2048.pem'

# Row level security
row_security = on

# =============================================================================
# CUSTOM SETTINGS FOR MCP MEMORY SERVER
# =============================================================================

# Application specific settings
application_name = 'mcp-memory-server'

# Time zone for application
timezone = 'UTC'

# Locale settings
lc_collate = 'en_US.UTF-8'
lc_ctype = 'en_US.UTF-8'

# Default transaction isolation
default_transaction_isolation = 'read committed'

# =============================================================================
# MONITORING AND MAINTENANCE
# =============================================================================

# Maintenance settings
maintenance_work_mem = 256MB
autovacuum_work_mem = 256MB

# Statistics for monitoring
log_parser_stats = off
log_planner_stats = off
log_executor_stats = off
log_statement_stats = off

# Checkpoint monitoring
log_checkpoints = on
checkpoint_warning = 30s

# =============================================================================
# RESOURCE LIMITS
# =============================================================================

# Resource limits
max_files_per_process = 4000
max_locks_per_transaction = 256
max_pred_locks_per_transaction = 256

# Shared memory
shared_memory_type = mmap
dynamic_shared_memory_type = posix

# =============================================================================
# ERROR HANDLING
# =============================================================================

# Error handling
exit_on_error = off
restart_after_crash = on
data_checksums = on

# Recovery settings
recovery_target_timeline = 'latest'
restore_command = 'cp /var/lib/postgresql/archive/%f %p'

# =============================================================================
# NOTES
# =============================================================================

# IMPORTANT NOTES:
# 1. Adjust memory settings based on available system RAM
# 2. Monitor performance and adjust settings accordingly
# 3. Regular VACUUM and ANALYZE operations are crucial
# 4. Consider connection pooling (PgBouncer) for high-concurrency workloads
# 5. Set up monitoring with tools like pg_stat_statements
# 6. Configure proper backup and recovery procedures
# 7. Use SSL/TLS for secure connections
# 8. Monitor log files for performance issues
# 9. Tune autovacuum settings based on workload patterns
# 10. Consider partitioning for large tables